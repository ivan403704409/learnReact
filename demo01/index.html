<!DOCTYPE html>
<html>
  <head>
    <title>React Search List</title>
    <script src="../build/react.js"></script>
    <script src="../build/react-dom.js"></script>
    <script src="../build/browser.min.js"></script>
    <script src="../build/jquery.min.js"></script>
  </head>
  <body>
    <div id="container"></div>

<script type="text/babel">
 


var SearchList = React.createClass({
  render: function () {
    var self = this;
    return(
      <ul style={{display: this.props.data.length ? 'block' : 'none', border: '1px solid #000'}} >
      {
        this.props.data.map(function (item, index){
          return <li data={index} style={{background: self.props.selectedIndex ==index ? '#eee' : '#fff'}} >{item['0']}</li>;
        })
      }
      </ul>
    );
  }
});

var SearchBox = React.createClass({
  getInitialState: function() {
      return {
          keyIndex: -1,
          data: [],
          cache: {}
      };
  },

  handleChange: function () {
    var q = this.refs.q.value;
    var self = this;

    var cachData = self.state.cache[q]
    if( cachData ){
      self.setState({
        keyIndex: -1,
        data: cachData
      });
      // return false;
    }else{
      $.ajax({
        url: 'https://suggest.taobao.com/sug',
        type: 'default GET (Other values: POST)',
        dataType: 'jsonp',
        jsonp: 'callback',
        data: {q: q}
      })
      .done(function(res) {
        var data = res.result;

        self.state.cache[q] = data;
        self.setState({
          keyIndex: -1,
          data: data,
          cache: self.state.cache
        });
      });
    }
    
  },

  handleKeyDown: function (ev) {
    var len = this.state.data.length;
    if( !len )return;

    var keyCode = ev.keyCode;
    var index = this.state.keyIndex;
    if( keyCode == 38){//上
      if( --index <= -1 )index = len-1; 
      this.setState({keyIndex: index});
    }else if( keyCode == 40 ){//下
      if( ++index >= len )index = 0;
      this.setState({keyIndex: index});
    }

  },

  render: function () {
    return(
      <div>
        <input placeholder="Search..." ref="q" onKeyDown={this.handleKeyDown} onChange={this.handleChange} />
        <SearchList selectedIndex={this.state.keyIndex} data={this.state.data} />
      </div>
    );
  }
});

ReactDOM.render(
  <SearchBox />,
  document.getElementById('container')
);


    </script>
  </body>
</html>
